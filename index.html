<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>面孔识别问卷</title>
  <script src="lib/jspsych-8.2.2/jspsych.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-html-keyboard-response.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-html-button-response.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-browser-check.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-preload.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-survey-text.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-survey-multi-choice.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-fullscreen.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-call-function.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-survey-html-form.js"></script>
  <script src="lib/jspsych-8.2.2/plugin-survey-likert.js"></script>
  <link href="lib/jspsych-8.2.2/jspsych.css" rel="stylesheet" type="text/css" />
  <!-- Credamo code -->
  <script src="/jspsych/static/credamo-jspsych.min.js"></script>
  <!-- External CSS -->
  <link rel="stylesheet" href="css/style.css">
  <!-- load js codes for the task -->
  <script type="text/javascript" src="param/param.js"></script>
  <script type="text/javascript" src="param/stimuli.js"></script>
  <script type="text/javascript" src="param/consent.js"></script>
  <script type="text/javascript" src="param/utils.js"></script>
</head>

<body></body>
<script>
  // 初始化jsPsych
  var jsPsych = initJsPsych({
    use_webaudio: false,
    on_close: function () {
      var filename = `${exp_name}_${subj_id}_${getLocalTimestamp()}`;
      if (isBaoleiji) {
        saveData(
          jsPsych.data.get().csv(),
          `${filename}_onclose.csv`
        );
      } else if (isCredamo) {
        onCredamoEndTrialFinish(jsPsych.data.get().csv());
      } else {
        // save data backup locally
        jsPsych.data.get().localSave('csv', `${filename}_onclose.csv`);
      }
    },
  });

  // the information is defined in param/param.js
  var user_browser = navigator.userAgent;
  console.log(user_browser);
  var start_time = getLocalTimestamp();
  jsPsych.data.addProperties({
    ExpName: exp_name,
    isBaoleiji: isBaoleiji,
    Browser: user_browser,
    StartsAt: start_time
  })

  // ==================== 实验流程 ====================
  var timeline = [];

  // check browser
  // var checkbrowser = {
  //   type: jsPsychBrowserCheck,
  //   minimum_width: 1000,
  //   minimum_height: 600,
  //   inclusion_function: (data) => {
  //     return data.mobile === false
  //   },
  //   exclusion_message: (data) => {
  //     if (data.mobile) {
  //       return '<p>本测验程序须在台式电脑或笔记本上运行。</p>';
  //     }
  //   }
  // };
  // timeline.push(checkbrowser);

  // use full screen
  var fullscreen = {
    type: jsPsychFullscreen,
    message: '<p>请按下按钮进入“全屏模式”以开始实验。</p>',
    button_label: '进入全屏',
    fullscreen_mode: true
  };
  timeline.push(fullscreen);

  // consent form
  var consentform = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: consent_text,
    choices: "NO_KEYS", // do not use keys
    data: { task: 'consent_form' },
    on_load: function () {
      // 同意按钮逻辑
      document.getElementById('consent-accept').addEventListener('click', function () {
        jsPsych.finishTrial({ consent: 'accepted' });
      });

      // 不同意按钮逻辑
      document.getElementById('consent-reject').addEventListener('click', function () {
        // 显示拒绝参与的信息
        document.querySelector('.jspsych-content').innerHTML = `
            <p>您已选择不参与本测验。</p>
            <p>感谢您的时间。您现在可以关闭本页面。</p>
          `;
      });
    }
  };
  timeline.push(consentform);

  // ==================== Pre-survey ====================
  var timeline_pre = [];

  // a1. subject ID input
  var subjid = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<p>请输入您的学号/工号或身份证号码：</p>" +
      "<p style='color: #444444;'> (如您没有学号/工号且不希望填写身份证信息，请输入“00000000”[共8位]，并牢记下一页面展示的被试编码。这将是后续研究验证您身份的重要凭证)</p>",
    html: `
    <input type="text" name="subjid" id="subjid" required 
           placeholder="例如：2024000100101" style="width: 200px;"><br><br>
    `,
    autofocus: 'subjid',
    on_finish: function (data) {
      subj_id = data.response.subjid;
      jsPsych.data.addProperties({ SubjCode: subj_id });
      console.log("Subject ID: ", subj_id);
    }
  };
  timeline_pre.push(subjid);

  // 1.5 Show random ID screen indefinitely for anonymous IDs
  var anon_id = jsPsych.randomization.randomID(15);
  jsPsych.data.addProperties({ Anon_id: anon_id });
  var show_or_skip_id = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
      return `
          <h2>您的实验编号是：</h2>
          <h1 style="color: red;">${anon_id}</h1>
          <p>请牢记此编号，后续研究需要使用此编号来验证您的身份。</p>
          <p>按“空格”键继续。</p>
        `;
    },
    choices: [' '],
    data: { task: 'anon_id_display' },
    on_finish: function () {
      // override SubjCode for anonymous participants
      subj_id = anon_id;
      jsPsych.data.addProperties({ SubjCode: subj_id });
      console.log("Generated anonymous Subject ID: ", subj_id);
    }
  };
  var if_node = {
    timeline: [show_or_skip_id],
    conditional_function: function () {
      // check if the subj_id is the anonymous code
      return subj_id === "00000000";
    }
  }
  timeline_pre.push(if_node);

  // a2. age input
  var subjage = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<p>请输入您的年龄：</p>",
    html: `
    <input type="text" name="age" id="age" pattern="^\\d{1,3}$" required 
           placeholder="例如：20" style="width: 150px;"
           title="请输入1到3位数字的年龄"><br><br>
    `,
    autofocus: 'age',
    on_finish: function (data) {
      subj_age = data.response.age;
      jsPsych.data.addProperties({ Age: subj_age });
      // Validate age range
      if (subj_age < 18) {
        // Display error message and abort experiment
        jsPsych.abortExperiment("很遗憾，您目前还不符合本测验的年龄要求（需至少18岁）。" +
          "<p>感谢您的时间。您现在可以关闭本页面。</p>");
      }
    }
  };
  timeline_pre.push(subjage);

  // a3. sex selection
  var subjsex = {
    type: jsPsychSurveyMultiChoice,
    questions: [
      {
        prompt: "您的性别是？",
        options: ["男", "女"],
        required: true,
        name: 'sex'
      }
    ],
    on_finish: function (data) {
      subj_sex = data.response.sex;
      jsPsych.data.addProperties({ Sex: subj_sex === "男" ? "male" : "female" });
    }
  };
  timeline_pre.push(subjsex);

  // a4. handedness selection
  var subjhandedness = {
    type: jsPsychSurveyMultiChoice,
    questions: [
      {
        prompt: "您的惯用手/利手是（例如通常吃饭或写字使用哪只手）？",
        options: ["左手", "右手"],
        required: true,
        name: 'handedness'
      }
    ],
    on_finish: function (data) {
      subj_handedness = data.response.handedness;
      jsPsych.data.addProperties({ Handedness: subj_handedness === "左手" ? "left" : "right" });
    }
  };
  timeline_pre.push(subjhandedness);

  // a5. brain injury history
  var subjbraininjury = {
    type: jsPsychSurveyMultiChoice,
    questions: [
      {
        prompt: "您有脑损伤史吗？",
        options: ["是", "否"],
        required: true,
        name: 'brain_injury'
      }
    ],
    on_finish: function (data) {
      subj_brain_injury = data.response.brain_injury;
      jsPsych.data.addProperties({ BrainInjury: subj_brain_injury === "是" ? "yes" : "no" });
    }
  };
  timeline_pre.push(subjbraininjury);

  // a6. phone number
  var subjcontact = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<p>如果您有兴趣参与本项目的后续研究，请输入您的手机号码：</p>" +
      "<p style='color: #444444;'> (如您决定不参与后续研究，请输入“0”)</p>",
    html: `
    <input type="text" name="phone" id="phone" pattern="^(\\d{1}|\\d{11})$" require
           placeholder="例如：13812345678" style="width: 150px;"
           title="请输入11位数字的手机号码"><br><br>
    `,
    autofocus: 'phone',
    on_finish: function (data) {
      subj_contact = data.response.phone;
      jsPsych.data.addProperties({ Contact: subj_contact });
    }
  };
  timeline_pre.push(subjcontact);

  var pre_summary = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function () {
      return `
          <h1>欢迎参加本测验！</h1>
          <br>
          <p>您的学号: <strong>${subj_id}</strong></p> 
          <p>年龄: <strong>${subj_age}</strong></p>
          <p>性别: <strong>${subj_sex}</strong></p>
          <p>利手: <strong>${subj_handedness}</strong></p>
          <p>脑损伤史: <strong>${subj_brain_injury}</strong></p>
          <p>手机号码: <strong>${subj_contact}</strong></p> 
          <br>
          <p>请确认以上信息是否正确？</p>

          <div class="confirm-buttons">
            <button class="jspsych-btn" id="confirm-edit">信息有误，需重新填写</button>
            <button class="jspsych-btn" id="confirm-confirm">信息正确</button>
          </div>
        `
    },
    choices: "NO_KEYS", // do not use keys
    data: { task: 'pre-survey-confirm' },
    on_load: function () {
      // 同意按钮逻辑
      document.getElementById('confirm-confirm').addEventListener('click', function () {
        jsPsych.finishTrial({ confirm: 'confirm' });
      });

      // 不同意按钮逻辑
      document.getElementById('confirm-edit').addEventListener('click', function () {
        // 显示拒绝参与的信息
        jsPsych.finishTrial({ confirm: 'redo' });
      });
    },
    on_finish: function (data) {
      confirm_info = jsPsych.data.get().filter({ task: 'pre-survey-confirm' }).last(1).values()[0].confirm;
    }
  };
  timeline_pre.push(pre_summary);

  // Add pre-survey timeline to the main timeline with potential loops
  timeline.push({
    timeline: timeline_pre,
    loop_function: function () {
      // continue looping if not all information is correct
      return confirm_info !== "confirm";
    }
  });

  // ==================== Main Experiment ====================
  // 根据屏幕宽度动态调整每页问题数
  function getQuestionsPerPage() {
    const screenWidth = window.innerWidth;
    if (screenWidth < 768) { // 手机
      return 4;
    } else { // 电脑
      return 5;
    }
  }
  const questionsPerPage = getQuestionsPerPage();
  // 计算总页数
  const totalQuestions = pi20_questions.length;
  const totalPages = Math.ceil(totalQuestions / questionsPerPage);

  console.log(`问卷分页: ${totalQuestions}题，每页${questionsPerPage}题，共${totalPages}页`);

  // 问卷指导语  
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <div style="text-align:center;">
          <h2>面孔识别问卷</h2>
          <p>接下来您将看到一系列关于面孔识别能力的描述。</p>
          <p>请评价每项描述与您的符合程度，并选择最符合您情况的选项。</p>
          <p>请仔细阅读每一个条目，并诚实作答。谢谢！</p>
        </div>
      `,
    choices: ['开始测验']
  });

  // ============= 问卷部分 - 使用jsPsych Likert插件 =============
  const allAnswers = {};

  // 循环创建每个页面
  for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
    const startIdx = pageIndex * questionsPerPage;
    const endIdx = Math.min(startIdx + questionsPerPage, totalQuestions);

    // 获取当前页的问题
    const currentQuestions = pi20_questions.slice(startIdx, endIdx);

    // 计算当前页的问题编号范围
    const firstQuestionNum = startIdx + 1;
    const lastQuestionNum = endIdx;

    // 创建当前页的试次
    timeline.push({
      type: jsPsychSurveyLikert,
      questions: currentQuestions,
      randomize_question_order: false,
      on_finish: function (data) {
        // 保存当前页的答案到全局对象
        if (data.response) {
          Object.assign(allAnswers, data.response);
        }

        // 如果是最后一页，将所有答案添加到当前试次的独立列中
        if (pageIndex === totalPages - 1) {
          console.log("最后一页，正在合并所有答案...");

          // 将全局存储的所有答案作为独立列添加到当前试次数据
          // 这样在最终的数据中，这一行就会有Q1-Q20的所有列
          for (let qNum = 1; qNum <= totalQuestions; qNum++) {
            const qKey = `Q${qNum}`;
            if (allAnswers[qKey] !== undefined) {
              // 将答案添加到data对象，jsPsych会自动将其保存为独立的数据列
              data[qKey] = allAnswers[qKey]+1; // +1调整为1-5评分
            }
          }

          // 添加合并标识
          data.allData = 'true';
        }
      }
    });
  }

  // experiment end and upload data
  timeline.push(save_data = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>测验结束，感谢您的参与！</p>
        <p>请按下方按钮上传您的测验数据。</p>
      `,
    choices: ['开始上传数据...'],
    data: { task: 'upload_data' },
    on_finish: function () {
      var filename = `${exp_name}_${subj_id}_${getLocalTimestamp()}`;
      if (isBaoleiji) {
        // upload clean data to server
        saveData(
          jsPsych.data.get().filter([{ allData: 'true' }]).filterColumns([
            'SubjCode', 'Anon_id', 'ExpName', 'isBaoleiji', 'Browser', 'StartsAt',
            'Age', 'Sex', 'Handedness', 'BrainInjury', 'Contact',
            'Q1', 'Q2', 'Q3', 'Q4', 'Q5',
            'Q6', 'Q7', 'Q8', 'Q9', 'Q10',
            'Q11', 'Q12', 'Q13', 'Q14', 'Q15',
            'Q16', 'Q17', 'Q18', 'Q19', 'Q20'
          ]).csv(),
          `${filename}.csv`
        );
        // upload data backup to server
        saveData(
          jsPsych.data.get().csv(),
          `${filename}_backup.csv`
        );
      } else if (isCredamo) {
        onCredamoEndTrialFinish(jsPsych.data.get().csv());
      } else {
        // save data locally
        jsPsych.data.get().filter([{ allData: 'true' }]).filterColumns([
          'SubjCode', 'Anon_id', 'ExpName', 'isBaoleiji', 'Browser', 'StartsAt',
          'Age', 'Sex', 'Handedness', 'BrainInjury', 'Contact',
          'Q1', 'Q2', 'Q3', 'Q4', 'Q5',
          'Q6', 'Q7', 'Q8', 'Q9', 'Q10',
          'Q11', 'Q12', 'Q13', 'Q14', 'Q15',
          'Q16', 'Q17', 'Q18', 'Q19', 'Q20'
        ]).localSave('csv', `${filename}.csv`);
        // save data backup locally
        jsPsych.data.get().localSave('csv', `${filename}_backup.csv`);
      }
    }
  });

  // exit fullscreen mode
  timeline.push({
    type: jsPsychFullscreen,
    fullscreen_mode: false,
    data: { trial_frame: 'keyinfo' },
    on_finish: function (data) {
      data.totaltime = (jsPsych.getTotalTime() / 60000).toFixed(2);
    }
  });

  // show cursor
  timeline.push(cursor_on);

  // 实验结束
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
        <p>测验数据已上传完成。</p>
        <p>再次感谢您的参与！</p>
      `,
    choices:['退出测验'], 
    data: { task: 'experiment_end' }
  });
  // ==================== 运行实验 ====================
  jsPsych.run(timeline);

</script>

</html>